#include <a_samp>
#include <Dini>

/*
 Script made by Daniel Andreev
 Script name: Система за регистрация и вход
*/

#define DIALOG_LOGIN 0
#define DIALOG_REGISTER 1
#define COLOR_RED 0xFF000FF
#define COLOR_WHITE 0xFFFFFFFF

new bool: isLogged[MAX_PLAYERS] = false;

enum pInfo
{
	pAdmin,
	pVip,
	pPassword[256],
	pCash
}
new PlayerInfo[MAX_PLAYERS][pInfo];

main()
{
		printf("\n· Скриптът се пусна успешно.");
		printf("·Made by Daniel Andreev\n\n");
}

stock ResetPlayerVariables(playerid)
{
isLogged[playerid] = false;
PlayerInfo[playerid][pVip]=0;
PlayerInfo[playerid][pCash]=0;
PlayerInfo[playerid][pAdmin]=0;
}

stock GivePlayerCash(playerid, cash)
{
PlayerInfo[playerid][pCash] = cash;
ResetPlayerMoney(playerid);
GivePlayerMoney(playerid,PlayerInfo[playerid][pCash]);
}

LoadAccount(playerid)
{
    new accountFileNickname[256];
    new accountNickname[MAX_PLAYER_NAME];
    GetPlayerName(playerid, accountNickname, 25);
    format(accountFileNickname, 256, "%s.ini", accountNickname);
    PlayerInfo[playerid][pAdmin]= dini_Int(accountFileNickname,"pAdmin");
    PlayerInfo[playerid][pVip]= dini_Int(accountFileNickname,"pVip");
    PlayerInfo[playerid][pCash]= dini_Int(accountFileNickname,"pCash");
    GivePlayerCash(playerid, 0); //Използвам вече създадена функция за даване на пари. Сложих 0, понеже само дава текущите пари!
}

public OnGameModeInit()
{
	SetGameModeText("Server With Register System");
	AddPlayerClass(0, 1958.3783, 1343.1572, 15.3746, 269.1425, 0, 0, 0, 0, 0, 0);
	return 1;
}

public OnGameModeExit()
{
	return 1;
}

public OnPlayerRequestClass(playerid, classid)
{
	SetPlayerPos(playerid, 1958.3783, 1343.1572, 15.3746);
	SetPlayerCameraPos(playerid, 1958.3783, 1343.1572, 15.3746);
	SetPlayerCameraLookAt(playerid, 1958.3783, 1343.1572, 15.3746);
	return 1;
}

public OnPlayerConnect(playerid)
{
	ResetPlayerVariables(playerid);
    new accountFileNickname[256];
    new accountNickname[MAX_PLAYER_NAME];
    GetPlayerName(playerid, accountNickname, 25);
    format(accountFileNickname, 256, "%s.ini", accountNickname);
	if(!dini_Exists(accountFileNickname))
	{
	new string256[256];
	format(string256,256,"{FFFFFF}Добре дошли в {FFFF00}Server Name\n\n{FFFFFF}Име: {33AA33}%s\n{FFFFFF}Статус: {FF0000}Не регистриран\n\n{FFFFFF}Моля, напишете с каква парола искате да регистрирате профила си.",accountNickname);
	ShowPlayerDialog(playerid,DIALOG_REGISTER,DIALOG_STYLE_PASSWORD,"Регистрация в сървъра",string256,"Регистрирай","Излез");
	}
	else
	{
	new string256[256];
	format(string256,256,"{FFFFFF}Добре дошли в {FFFF00}Server Name\n\n{FFFFFF}Име: {33AA33}%s\n{FFFFFF}Статус: {33AA33}Регистриран\n\n{FFFFFF}Моля, напишете паролата с която сте регистриран.",accountNickname);
	ShowPlayerDialog(playerid,DIALOG_LOGIN,DIALOG_STYLE_PASSWORD,"Вход в сървъра",string256,"Влез","Излез");
	}
	TogglePlayerSpectating(playerid, true);
	return 1;
}

public OnPlayerDisconnect(playerid, reason)
{
	return 1;
}

public OnPlayerSpawn(playerid)
{
	return 1;
}

public OnPlayerDeath(playerid, killerid, reason)
{
	return 1;
}

public OnVehicleSpawn(vehicleid)
{
	return 1;
}

public OnVehicleDeath(vehicleid, killerid)
{
	return 1;
}

public OnPlayerText(playerid, text[])
{
	return 1;
}

public OnPlayerCommandText(playerid, cmdtext[])
{
	return 0;
}

public OnPlayerEnterVehicle(playerid, vehicleid, ispassenger)
{
	return 1;
}

public OnPlayerExitVehicle(playerid, vehicleid)
{
	return 1;
}

public OnPlayerStateChange(playerid, newstate, oldstate)
{
	return 1;
}

public OnPlayerEnterCheckpoint(playerid)
{
	return 1;
}

public OnPlayerLeaveCheckpoint(playerid)
{
	return 1;
}

public OnPlayerEnterRaceCheckpoint(playerid)
{
	return 1;
}

public OnPlayerLeaveRaceCheckpoint(playerid)
{
	return 1;
}

public OnRconCommand(cmd[])
{
	return 1;
}

public OnPlayerRequestSpawn(playerid)
{
	return 1;
}

public OnObjectMoved(objectid)
{
	return 1;
}

public OnPlayerObjectMoved(playerid, objectid)
{
	return 1;
}

public OnPlayerPickUpPickup(playerid, pickupid)
{
	return 1;
}

public OnVehicleMod(playerid, vehicleid, componentid)
{
	return 1;
}

public OnVehiclePaintjob(playerid, vehicleid, paintjobid)
{
	return 1;
}

public OnVehicleRespray(playerid, vehicleid, color1, color2)
{
	return 1;
}

public OnPlayerSelectedMenuRow(playerid, row)
{
	return 1;
}

public OnPlayerExitedMenu(playerid)
{
	return 1;
}

public OnPlayerInteriorChange(playerid, newinteriorid, oldinteriorid)
{
	return 1;
}

public OnPlayerKeyStateChange(playerid, newkeys, oldkeys)
{
	return 1;
}

public OnRconLoginAttempt(ip[], password[], success)
{
	return 1;
}

public OnPlayerUpdate(playerid)
{
	return 1;
}

public OnPlayerStreamIn(playerid, forplayerid)
{
	return 1;
}

public OnPlayerStreamOut(playerid, forplayerid)
{
	return 1;
}

public OnVehicleStreamIn(vehicleid, forplayerid)
{
	return 1;
}

public OnVehicleStreamOut(vehicleid, forplayerid)
{
	return 1;
}

public OnDialogResponse(playerid, dialogid, response, listitem, inputtext[])
{
	//Register panel response
	if(dialogid==DIALOG_REGISTER)
	{
	if(!response){
	SendClientMessage(playerid,COLOR_RED,"Сървър: Вие пожелахте да напуснете сървъра.");
	Kick(playerid);
	return 1;
	}
	if(strlen(inputtext)<4 || strlen(inputtext)>20)
    {
    SendClientMessage(playerid,COLOR_WHITE,"Сървър: Паролата трябва да съдържа между 4 и 20 символа");
    new string256[256];
	format(string256,256,"{F0F0F0}Профилът ви все още не е регистриран.\nВъведете паролата си отдолу");
	ShowPlayerDialog(playerid,DIALOG_REGISTER,DIALOG_STYLE_PASSWORD,"Регистрация:",string256,"Регистрирай","Излез");
    return 1;
    }
    new accountFileNickname[256];
    new accountNickname[MAX_PLAYER_NAME];
    new string256[256];
    format(string256,256,"Вие успешно регистрирахте {33aa33}%s{ffffff}. Добре дошли в {33aa33}Server Name",accountNickname);
	SendClientMessage(playerid,COLOR_WHITE,string256);
	SendClientMessage(playerid,COLOR_WHITE,"");
	TogglePlayerSpectating(playerid, false);
	isLogged[playerid]=true;
    GetPlayerName(playerid, accountNickname, 25);
    format(accountFileNickname, 256, "%s.ini", accountNickname);
	dini_Create(accountFileNickname);
    dini_Set(accountFileNickname, "pPassword", inputtext);
    format(PlayerInfo[playerid][pPassword],256,inputtext);
    GivePlayerCash(playerid,250);
	}
	//Login panel response
    if(dialogid==DIALOG_LOGIN)
	{
	if(!response){
	SendClientMessage(playerid,COLOR_RED,"Сървър: Вие пожелахте да напуснете сървъра.");
	Kick(playerid);
	return 1;
	}
	if(strlen(inputtext)<4 || strlen(inputtext)>20)
    {
    SendClientMessage(playerid,COLOR_WHITE,"Сървър: Паролите тук съдържат между 4 и 20 символа.");
    new string256[256];
	format(string256,256,"{F0F0F0}Профилът ви е регистриран, но вие все още не сте в него.\nВъведете паролата си отдолу за да влезете");
	ShowPlayerDialog(playerid,DIALOG_LOGIN,DIALOG_STYLE_PASSWORD,"Вход:",string256,"Влез","Излез");
    return 1;
    }
    new accountFileNickname[256];
    new accountNickname[MAX_PLAYER_NAME];
    GetPlayerName(playerid, accountNickname, 25);
    format(accountFileNickname, 256, "%s.ini", accountNickname);
    new password[25];
    format(password, 25, "%s", dini_Get(accountFileNickname, "pPassword"));
    if(strcmp(inputtext, password)==0)
    {
    new string256[256];
    format(string256,256,"Вие успешно {33AA33}влязохте {ffffff}, като {33AA33}%s",accountNickname);
	SendClientMessage(playerid,COLOR_WHITE,string256);
	LoadAccount(playerid);
	TogglePlayerSpectating(playerid, false);
	isLogged[playerid]=true;
    }
    else
	{
    new string256[256];
	format(string256,256,"Сървър: Въведената парола е невалидна!");
	SendClientMessage(playerid,COLOR_RED,string256);
	format(string256,256,"{F0F0F0}Профилът ви е регистриран, но вие все още не сте в него.\nВъведете паролата си отдолу за да влезете");
	ShowPlayerDialog(playerid,DIALOG_LOGIN,DIALOG_STYLE_PASSWORD,"Вход:",string256,"Влез","Излез");
	}
	}
	return 1;
}

public OnPlayerClickPlayer(playerid, clickedplayerid, source)
{
	return 1;
}
